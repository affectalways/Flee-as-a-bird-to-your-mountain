# 20.MySQL记录锁、间隙锁、临键锁小案例演示

### 目录

- [前言](#前言)
- [数据和环境准备](#数据和环境准备)
- [唯一索引示例](#唯一索引示例)
- [普通索引示例](#普通索引示例)
- [无索引示例](#无索引示例)
- [参考链接](#参考链接)





### 前言

> 生成间隙(gap)锁、临键(next-key)锁的前提条件 是在 RR 隔离级别下。

这篇主要通过小案例来对记录锁、间隙(gap)锁、临键(next-key)锁做一个更好的理解。

这里先给出结论，再来用实际例子证明

> 1、当使用唯一索引来等值查询的语句时, 如果这行数据存在，不产生间隙锁，而是记录锁。

> 2、当使用唯一索引来等值查询的语句时, 如果这行数据不存在，会产生间隙锁。

> 3、当使用唯一索引来范围查询的语句时，对于满足查询条件但不存在的数据产生间隙(gap)锁，如果查询存在的记录就会产生记录锁，加在一起就是临键锁(next-key)锁。

> 4、当使用普通索引不管是锁住单条，还是多条记录，都会产生间隙锁；

> 5、在没有索引上不管是锁住单条，还是多条记录，都会产生表锁；

**间隙锁**会封锁该条记录相邻两个键之间的空白区域，防止其它事务在这个区域内插入、修改、删除数据，这是为了防止出现 **幻读** 现象；

**间隙的范围？**

根据检索条件向下寻找最靠近检索条件的记录值A作为左区间，向上寻找最靠近检索条件的记录值B作为右区间，即锁定的间隙为（A，B] **左开右闭**。

接下来我们开始来验证以上结论





### 数据和环境准备

##### 创建表和数据

```
CREATE TABLE `t` (
  `id` int  COMMENT '主键',
  `age` int COMMENT '年龄',
  `mobile` int  COMMENT '手机号',
  `name` varchar(8)COMMENT '名称',
  PRIMARY KEY (`id`),
  KEY `index_age` (`age`)
) ENGINE=InnoDB AUTO_INCREMENT=8;
```

id为主键(唯一索引)、age是普通索引、mobile没有加索引

同时插入数据如下。

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A31.png)

在进行测试之前，我们先来看看t表中存在的隐藏间隙：

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A32.png)

(-∞, 1]
(1, 4]
(4, 7]
(7, +supernum]（其中supernum是数据库维护的最大的值。为了保证间隙锁都是左开右闭原则。）

##### 关闭事务默认提交

```
mysql> SHOW VARIABLES LIKE 'autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
1 row in set (0.00 sec)
```

结果显示，autocommit 的值是 ON，表示**系统开启自动提交模式**。

使用 SET autocommit 关闭自动提交模式，语法格式如下：

```
SET autocommit = OFF;
```





### 唯一索引示例

##### 等值查询且数据存在示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A33.png)

事务A 等值查询id=4，因为id是主键，同时是等值查询存在该记录,所以只会在id=4这条记录上加记录锁，不会加间隙锁。

事务B 等值查询id=5，没有锁冲突，所以查询正常，不会堵塞。(如果事务B 等值查询id=4,因为事务A加了记录锁，所以会堵塞)



##### 等值查询且数据不存在示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A34.png)

事务A 等值查询id=5，因为查询记录不存在，所以无法加记录锁，但这里会存在一个(5,7]的间隙锁。

事务B 插入一条id=6的数据，因为上面存在了(5,7]的间隙锁，所以会堵塞。



##### 范围查询示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A35.png)

事务A 范围查询id>4，那么这里就会存在一个(4,+supernum]的临键(next-key)锁。

事务B 插入一条id=6的数据，因为上面存在了(4,+supernum]的临键(next-key)锁，所以会堵塞。

如果 事务B 是更新 id=7 的记录，同样会堵塞。





### 普通索引示例

##### 等值查询值示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A36.png)

事务A 等值查询age=4，因为age是普通索引，所以会产生临键(next-key)锁，范围(1,4]和(4,7](左开右闭原则)。

事务B 插入一个id=6、age=6的数据，因为age值在上面临键锁范围内，所以也会堵塞。



##### 左开右闭原则

按照上面的例子，如果是左开右闭原则，那就是age临键锁的范围是(1,7]。

如果事务B插入一条 id=6，age=1 的数据，正常是不是不会堵塞，因为按照左开右闭原则，上面的age=1是开的，所以正常应该是可以插入的。

但实际上你真是实践之后，你发现同样也会堵塞。

通过实践之后，会发现，所谓的左开右闭原则，并不是一定是左开右闭，而是跟主键id有关系。

上面的事务A 等值查询age=4，它的当前主键id=4，上一条记录主键id=1，下条记录主键id=7。

如果插入 id<1 ,age 在(1,7)范围内，是 **左闭右开**原则。即age=1能插入，age=7会堵塞。

如果插入 1<id<7 ,age 在(1,7)范围内，是 **左闭右闭**原则。即age=1会堵塞，age=7也会堵塞。

如果插入 id>7 ,age 在(1,7)范围内，是 **左开右闭**原则。即age=1会堵塞，age=7能插入。

有关等值查询值不存在、普通索引范围的示例这里就不举了，跟上面的差不多，都会产生间隙锁。





### 无索引示例

##### 等值查询值示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A37.png)

**事务A** 等值查询 mobile = 8888884，因为mobile是无索引的，所以这个for update，变成表级排他(X)锁。

**事务B** 因为事务A已经加了表级的排他锁，所以其它事务无法进行任何的增删改操作。



##### 范围查询示例

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/%E8%AE%B0%E5%BD%95%E9%94%81%E8%AF%A6%E8%A7%A38.png)

**事务A** 等值查询 mobile > 8888884，因为mobile是无索引的，同样变成表级排他(X)锁。

**事务B** 因为事务A已经加了表级的排他锁，所以其它事务无法进行任何的增删改操作。





### 参考链接

- https://mp.weixin.qq.com/s?__biz=MzIzNjg4OTcyNA==&mid=2247483839&idx=1&sn=006bd1bdaedd311b7ebbf824a3d7e251&chksm=e8d1b2acdfa63bbae2022e2cc2925c512e2b193426f7dd487d0d6040a500b1e06b73530ec084&cur_album_id=2138177096085471232&scene=190#rd