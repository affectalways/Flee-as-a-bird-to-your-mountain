# 4.事务-隔离性问题

**目录**

- [引子](#引子)
- [隔离性问题](#隔离性问题)

  - [脏读](#脏读)

  - [不可重复读](#不可重复读)

  - [幻读](#幻读)
- [串行化可以解决幻读](#串行化可以解决幻读)
- [隔离级别与隔离问题的关联](#隔离级别与隔离问题的关联)



## 引子

​		当数据库上有多个事务同时执行时，就可能出现**脏读（dirty read）、不可重复读（non-repeatable read）、幻读（phantom read）**的问题，为了解决这些问题，就有了“隔离级别”的概念。



## 隔离性问题

### 脏读

> 事务A读到了事务B已经修改但尚未提交的数据

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/MySQL/pictures/3.%E4%BA%8B%E5%8A%A1-%E9%9A%94%E7%A6%BB%E6%80%A7%E9%97%AE%E9%A2%98-%E8%84%8F%E8%AF%BB.png?raw=true)

结果：

​		事务**A读到了**事务B**还没提交的中间状态**，即产生了**脏读**。



### 不可重复读

> 事务A读到了事务B已经提交的修改数据

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/MySQL/pictures/3.%E4%BA%8B%E5%8A%A1-%E9%9A%94%E7%A6%BB%E6%80%A7%E9%97%AE%E9%A2%98-%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB.png)

结果：

​		事务B 没有提交事务时，事务A **不会读到**事务B**修改的中间状态**，即read committed解决了上面所说的脏读问题。

​		但是当事务B中的事务提交后，事务A读到了修改后的记录，而对于事务A来说，仅仅读了两次，却读到了两个不同的结果，违背了事务之间的隔离性，所以说该事务隔离级别下产生了**不可重复读**的问题。



### 幻读

> 事务A读到了事务B提交的新增数据

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/MySQL/pictures/3.%E4%BA%8B%E5%8A%A1-%E9%9A%94%E7%A6%BB%E6%80%A7%E9%97%AE%E9%A2%98-%E5%B9%BB%E8%AF%BB.png)

结果：

​		事务B **已提交的修改记录**在事务A 中是**不可见的**，说明该事务隔离级别下解决了上面 **不可重复读** 的问题。

​		但魔幻的是一开始事务A中虽然**读不到**事务B中的**新增记录**，**却可以更新这条新增记录**，**执行更新(`update`)后，在事务A中居然可见该新增记录了**，这便产生了所谓的**幻读**问题。

**为什么会出现这样莫名其妙的结果？** 别急，后文会慢慢揭开这个神秘的面纱。先看如何解决幻读问题。



## 串行化可以解决幻读

> 串行化会在之后的文章有详解

操作：

1. 事务隔离级别设置为串行化
2. 事务A查询所有用户余额，不提交事务
3. 事务B执行insert、delete、update等操作
4. 图形化界面会报如下错误

```
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
```

结果：

​		只要事务A中的事务一直不提交，会话B 中尝试更改数据(`insert`、`delete`、`update`)的事务都会被阻塞至超时(`timeout`)。显然，该事务隔离级别下能有效解决上面幻读、不可重复读、脏读等问题。



> **注意：**除非是一些特殊的应用场景需要`serializable`事务隔离级别，否则很少会使用该隔离级别，因为并发性极低。





## 隔离级别与隔离问题的关联

| 事务隔离级别 | 脏读   | 不可重复读 | 幻读   |
| ------------ | ------ | ---------- | ------ |
| 读未提交     | 可能   | 可能       | 可能   |
| 读已提交     | 不可能 | 可能       | 可能   |
| 可重复读     | 不可能 | 不可能     | 可能   |
| 串行化       | 不可能 | 不可能     | 不可能 |
