# 17.索引-InnoDB索引实现

​		在MySQL中，索引属于存储引擎级别的概念。不同存储引擎对索引的实现方式是不同的，这里主要看下`InnoDB`存储引擎的索引实现方式。

</br></br>

### InnoDB主键索引实现

​		`InnoDB`的`主键索引`也使用`B+Tree`作为索引结构，叶子节点`data`域保存了**完整的数据记录**。

[![InnoDB主键索引原理图](https://img2020.cnblogs.com/blog/1546632/202009/1546632-20200919222451055-995072120.png)](https://img2020.cnblogs.com/blog/1546632/202009/1546632-20200919222451055-995072120.png)

​		`InnoDB`存储引擎中的主键索引又叫做**聚簇索引**(`clustered index`)。

​		因为InnoDB的数据文件需要要按照主键聚簇，所以InnoDB要求表必须有主键（MyISAM可以没有），如果没有显式指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整形。(详情见官方文档：`https://dev.mysql.com/doc/refman/5.7/en/innodb-index-types.html`)

​		聚簇索引这种实现方式使得按主键搜索十分高效，直接能查出整行数据。

​		在InnoDB中，用非单调递增的字段作为主键不是个好主意，因为InnoDB数据文件本身是一棵`B+Tree`，非单增的主键会造成在插入新记录时数据文件为了`维持B+Tree的特性`而频繁的分裂调整，十分低效，因而使用`递增`字段作为主键则是一个很好的选择。



</br></br>

## InnoDB非主键索引实现

​		InnoDB的非主键索引`data`域存储相应记录`主键的值`。换句话说，InnoDB的所有非主键索引都引用主键的值作为data域。如下图所示：

[![InnoDB非主键索引原理图](https://img2020.cnblogs.com/blog/1546632/202009/1546632-20200919225813936-1490118290.png)](https://img2020.cnblogs.com/blog/1546632/202009/1546632-20200919225813936-1490118290.png)

​		由上图可知：使用非主键索引搜索时需要检索两遍索引，首先检索非主键索引获得主键(`primary key`)，然后用主键到`主键索引树`中检索获得完整记录。

​		那么为什么非主键索引结构叶子节点存储的是主键值，而不像主键索引那样直接存储完整的一行数据，这样就能避免回表二次检索？显然，这样做一方面节省了大量的存储空间，另一方面多份冗余数据，更新数据的效率肯定低下，另外保证数据的一致性是个麻烦事。

​		到了这里，也很容易明白为什么`不建议使用过长的字段作为主键`，因为所有的非主键索引都引用主键值，过长的主键值会让非主键索引变得过大。
