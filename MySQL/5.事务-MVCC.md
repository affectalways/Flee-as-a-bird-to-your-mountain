# 5.事务-MVCC

> InnoDB存储引擎的默认事务隔离级别**可重复读(`repeatable read`)**（简称RR），是通过 "**行级锁+MVCC**"一起实现的。
>
> 需要注意的是，在SQL标准中，RR是无法避免幻读问题的，但是**InnoDB实现的RR避免了幻读问题**。

​		

> RR解决脏读、不可重复读、幻读等问题，使用的是MVCC



## 定义

​		**MVCC**（Multi-Version Concurrency Control），即多版本并发控制。指的是一种提高并发的技术。最早期的数据库系统，只有读读之间可以并发，读写、写读、写写都要阻塞。引入MVCC之后，只有**写写之间相互阻塞**，其他三种操作都可以并行，这样大幅度提高了`InnoDB`的并发性能。

​		在内部实现中，`InnoDB`通过`undo log`保存每条数据的多个版本，并且能够提供数据历史版本给用户读，每个事务读到的数据版本可能是不一样的。在同一个事务中，用户只能看到该事务创建快照之前已经提交的修改和该事务本身做的修改。

​		简单来说，`MVCC`是**维持一个数据的多个版本，使得读写操作没有冲突**。

> MVCC在`read committed`和`repeatable read`两个事务隔离级别下工作。

> MVCC最大的优点是读不加锁，因此读写不冲突，并发性能好。



## 案例

​		下面的例子很好的体现了MVCC的特点：在同一时刻，不同的事务读取到的数据可能是不同的(即多版本)——在T5时刻，事务A和事务C可以读取到不同版本的数据。

![](https://github.com/affectalways/Flee-as-a-bird-to-your-mountain/blob/main/MySQL/pictures/5.%E4%BA%8B%E5%8A%A1-MVCC-%E6%A1%88%E4%BE%8B1.png?raw=true)



## 实现

InnoDB实现MVCC，多个版本的数据可以共存，主要基于以下技术及数据结构：

- 隐藏字段
- 基于undo log的版本链
- ReadView结构



#### 隐藏字段

`InnoDB`存储引擎在每行数据的后面添加了三个隐藏字段，如下图所示：

## **参考链接**

- [《MySQL中MVCC的正确打开方式（源码佐证）》](https://blog.csdn.net/Waves___/article/details/105295060) 

- [《InnoDB事务分析-MVCC》](http://www.leviathan.vip/2019/03/20/InnoDB的事务分析-MVCC/)

- [《Innodb中的事务隔离级别和锁的关系》](https://tech.meituan.com/2014/08/20/innodb-lock.html) 
- [[深入学习MySQL事务：ACID特性的实现原理 ](https://www.cnblogs.com/kismetv/p/10331633.html)](https://www.cnblogs.com/kismetv/p/10331633.html)

