# 字典

**目录**

- [简介](#简介)

- [实现](#实现)

  - [哈希表](#哈希表)
  - [哈希表节点](#哈希表节点)

  

## 简介

​		字典：是一种用于保存键值对（key-value）的抽象数据结构

​		在字典中，一个键可以和一个value进行关联

​		字典中的每个键都是独一无二的，程序可以在字典中根据键查找对应的值，或者通过键更新值，或者根据键删除整个键值对

​		C语言中没有内置字典这种数据结构，因此Redis自己实现了字典

​		字典在 Redis 中的应用相当广泛， 比如 Redis 的数据库就是使用字典来作为底层实现的， 对数据库的增、删、查、改操作也是构建在对字典的操作之上的。

​		举个例子， 当我们执行命令：

```
redis> SET msg "hello world"
OK
```

​		在数据库中创建一个键为 `"msg"` ， 值为 `"hello world"` 的键值对时， 这个键值对就是保存在代表数据库的字典里面的。

​		除了用来表示数据库之外， 字典还是哈希的底层实现之一。



## 实现

​		Redis 的字典使用哈希表作为底层实现， 一个哈希表里面可以有多个哈希表节点， 而每个哈希表节点就保存了字典中的一个键值对

#### 哈希表

​		Redis 字典所使用的哈希表由 `dict.h/dictht` 结构定义：

```
typedef struct dictht {

    // 哈希表数组
    dictEntry **table;

    // 哈希表大小
    unsigned long size;

    // 哈希表大小掩码，用于计算索引值
    // 总是等于 size - 1
    unsigned long sizemask;

    // 该哈希表已有节点的数量
    unsigned long used;

} dictht;
```

`table` 属性是一个数组， 数组中的每个元素都是一个指向 `dict.h/dictEntry` 结构的指针， 每个 `dictEntry` 结构保存着一个键值对。

`size` 属性记录了哈希表的大小， 也即是 `table` 数组的大小， 而 `used` 属性则记录了哈希表目前已有节点（键值对）的数量。

`sizemask` 属性的值总是等于 `size - 1` ， 这个属性和哈希值一起决定一个键应该被放到 `table` 数组的哪个索引上面。

下图展示了一个大小为4的空哈希表（没有包含任何键值对）

![](F:\Flee-as-a-bird-to-your-mountain\Redis\pictures\05字典\01.png)

#### 哈希表节点

​		哈希表节点使用 `dictEntry` 结构表示， 每个 `dictEntry` 结构都保存着一个键值对：

```
typedef struct dictEntry {

    // 键
    void *key;

    // 值
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
    } v;

    // 指向下个哈希表节点，形成链表
    struct dictEntry *next;

} dictEntry;
```

`key` 属性保存着键值对中的键， 而 `v` 属性则保存着键值对中的值， 其中键值对的值可以是一个指针， 或者是一个 `uint64_t` 整数， 又或者是一个 `int64_t` 整数。

`next` 属性是指向另一个哈希表节点的指针， 这个指针可以将多个哈希值相同的键值对连接在一次， 以此来解决键冲突（collision）的问题。

举个例子，下图就展示了如何通过 `next` 指针， 将两个索引值相同的键 `k1` 和 `k0` 连接在一起。