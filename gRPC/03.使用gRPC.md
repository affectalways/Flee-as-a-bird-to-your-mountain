# 02.使用gRPC

### 目录

- [准备](#准备)
- [运行gRPC应用程序](#运行gRPC应用程序)
- [生成gRPC代码](#生成gRPC代码)
- [更新gRPC服务](#更新gRPC服务)
- [更新并运行应用程序](#更新并运行应用程序)
  - [更新服务器](#更新服务器)
  - [更新客户端](#更新客户端)

- [参考链接](#参考链接)



</br></br>

通过一个简单的工作示例开始使用 Python 中的 gRPC

</br>

### 准备

1. Python 3.5 或更高版本

2. 安装gRPC

   ```
   pip install grpcio
   ```

3. 安装gRPC工具包

   python的gRPC工具包包括protocol buffers编译器和用于从服务

   ```
   
   ```

4. 获取样例

```
# Clone the repository to get the example code:
$ git clone -b v1.50.0 --depth 1 --shallow-submodules https://github.com/grpc/grpc
# Navigate to the "hello, world" Python example:
$ cd grpc/examples/python/helloworld
```



</br></br>

### 运行gRPC应用程序

进入examples/python/helloworld目录

1. 运行服务端

   ```
   python greeter_server.py
   ```

2. 另起窗口，运行客户端

   ```
   python greeter_client.py
   ```

   

</br></br>

### 更新gRPC服务

现在看看如何在服务器上使用一个额外的方法来更新应用程序以供客户端调用。

我们的 gRPC 服务是使用protocol buffers定义的：[您可以在gRPC 简介](https://grpc.io/docs/what-is-grpc/introduction/)和[基础教程](https://grpc.io/docs/languages/python/basics/)中找到更多关于如何在`.proto` 文件中定义服务的信息。

现在只需要知道服务器和客户端`stub`都有一个RPC 方法，它从客户端获取一个参数并从服务器返回一个参数 ，这个方法定义如下：`SayHello`, `HelloRequest`, `HelloReply`

```proto
// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
}
```

对其进行更新，以便该`Greeter`服务具有两种方法。 使用具有相同请求和响应类型的新方法编辑 `examples/protos/helloworld.proto`和更新它：`SayHelloAgain`

```
// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
  // Sends another greeting
  rpc SayHelloAgain (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
}
```

</br></br>



### 生成gRPC代码

接下来我们需要更新应用程序使用的 gRPC 代码以使用新的服务定义。

从`examples/python/helloworld`目录中运行：

```
python -m grpc_tools.protoc -I../../protos --python_out=. --pyi_out=. --grpc_python_out=. ../../protos/helloworld.proto
```

这会重新生成`helloworld_pb2.py`，其中包含我们生成的请求和响应类以及`helloworld_pb2_grpc.py`我们生成的客户端和服务器类。



</br></br>

### 更新并运行应用程序

我们现在有了新生成的服务器和客户端代码，但我们仍然需要在示例应用程序的人工编写部分中实现和调用新方法。

</br>

#### 更新服务器

在同一目录中，打开`greeter_server.py`. 像这样实现新方法：

```python
class Greeter(helloworld_pb2_grpc.GreeterServicer):

  def SayHello(self, request, context):
    return helloworld_pb2.HelloReply(message='Hello, %s!' % request.name)

  def SayHelloAgain(self, request, context):
    return helloworld_pb2.HelloReply(message='Hello again, %s!' % request.name)
...
```

</br>

#### 更新客户端

在同一目录中，打开`greeter_client.py`. 像这样调用新方法：

```python
def run():
    with grpc.insecure_channel('localhost:50051') as channel:
        stub = helloworld_pb2_grpc.GreeterStub(channel)
        response = stub.SayHello(helloworld_pb2.HelloRequest(name='you'))
        print("Greeter client received: " + response.message)
        response = stub.SayHelloAgain(helloworld_pb2.HelloRequest(name='you'))
        print("Greeter client received: " + response.message)
```

就像我们之前所做的那样，从`examples/python/helloworld`目录中：

1. 运行服务器：

   ```sh
   $ python greeter_server.py
   ```

2. 从另一个终端运行客户端：

   ```sh
   $ python greeter_client.py
   ```





</br></br>

### 参考链接

- https://segmentfault.com/a/1190000039717888
- https://www.liwenzhou.com/posts/Go/gRPC/
- https://xy2401.com/local-docs/oschina/gRPC+%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%96%87%E7%89%88_V1.0.html