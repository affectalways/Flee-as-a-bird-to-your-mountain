# 09.聚合

$sum:1表示有一行就+1

$gender 用gender 这个属性作为分组依据。

`$sum '$age'`对age进行相加





### 聚合 aggregate

- 聚合(aggregate)主要用于计算数据，类似sql中的sum()、avg()
- 语法

```
db.集合名称.aggregate([
	{
		管道:{表达式}
	}
])
```





### 管道

- 管道在Unix和Linux中一般用于将当前命令的输出结果作为下一个命令的输入

ps ajx | grep mongo

- 在mongodb中，管道具有同样的作用，文档处理完毕后，通过管道进行下一次处理
- **常用管道**

- - $group：将集合中的文档分组，可用于统计结果
  - $match：过滤数据，只输出符合条件的文档
  - $project：修改输入文档的结构，如重命名、增加、删除字段、创建计算结果，显示所需要的字段。
  - $sort：将输入文档排序后输出
  - $limit：限制聚合管道返回的文档数
  - $skip：跳过指定数量的文档，并返回余下的文档
  - $unwind：将数组类型的字段进行拆分

​          



### 表达式

- 处理输入文档并输出
- 语法

```
    表达式:'$列名'
```

- 常用表达式

- - $sum：计算总和，$sum:1同count表示计数
  - $avg：计算平均值
  - $min：获取最小值
  - $max：获取最大值
  - $push：在结果文档中的值插入到一个数组中
  - $first：根据资源文档的排序获取第一个文档数据
  - $last：根据资源文档的排序获取最后一个文档数据





### $group

- **将集合中的文档分组，可用于统计结果**
- _id表示分组的依据，使用某个字段的格式为'$字段'

**_id：“$age”，表示以age列进行分组。**

**count:{$sum:1}，表示每有一行age相同count就+1，然后最终结果显示给count，count显示**

**$sum是表达式**

  ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0901.png)





求平均年龄，$avg:"age"，计算 age列的平均值。

$sum,$avg是表达式

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0902.png)





- 例1：统计男生、女生的总人数

```
db.stu.aggregate([    
	{
		$group: {
        	_id:'$gender',
            counter:{$sum:1}        
        }    
     } 
])
```

**Group by null**

- 将集合中所有文档分为一组
- 例2：求学生总人数、平均年龄

```
db.stu.aggregate([    
	{
		$group:        
            {            
                _id:null,            
                counter:{$sum:1},
                avgAge:{$avg:'$age'}        
             }    
     } 
])
```

**透视数据**

- 例3：统计学生性别及学生姓名

```
db.stu.aggregate([    
	{
		$group:        
			{            
				_id:'$gender',            
				name:{
					$push:'$name'
				}        
			}    
	} 
])
```

 ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0903.png)



- **使用$$ROOT可以将符合group条件的文档内容加入到结果集的数组中**，代码如下

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0904.png)

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0905.png)





### $match

- **用于过滤数据，只输出符合条件的文档**
- 使用MongoDB的标准查询操作
- 例1：查询年龄大于20的学生

```
db.stu.aggregate([    {$match:{age:{$gt:20}}} ])
```

  ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0906.png)

- 例2：查询年龄大于20的男生、女生人数

```
db.stu.aggregate([    
{
    $match:{
        age:{$gt:20}
    }

},    
{
    $group:{
        _id:'$gender',
        counter:{$sum:1}
    }
} 
])
```

   ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0908.png)



**注意：有多少个大括号。**

**注意：$match 得到的结果，作为$group的输入。**





### $project

- 修改输入文档的结构，如重命名、增加、删除字段、创建计算结果
- 例1：查询学生的姓名、年龄

```
db.stu.aggregate([
	{
		$project:{
			_id:0,
			name:1,
			age:1
		}
	} 
])
```

- 例2：查询男生、女生人数，输出人数

```
db.stu.aggregate([
    {
    	$group:{
    		_id:'$gender',
    		counter:{
    			$sum:1
    			}
    		}
    	},
    {
    	$project:{
    		_id:0,
    		counter:1
    	}
    }
])
```

 ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0909.png)

不显示_id，显示name，age





### $sort

- 将输入文档排序后输出
- 例1：查询学生信息，按年龄升序排序

```
b.stu.aggregate([
	{
		$sort:{
			age:1
		}
	}
])
```



- 例2：查询男生、女生人数，按人数降序

```
db.stu.aggregate([
    {
    	$group:{
    		_id:'$gender',
    		counter:{
    			$sum:1
    		}
    	}
    },
    {
    	$sort:{
    		counter:-1
    	}
    }
])
```



- **按年龄升序排序**

​    ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0910.png)





### $limit

- 限制聚合管道返回的文档数
- 例1：查询2条学生信息

```
db.stu.aggregate([
	{
		$limit:2
	}
])
```





### $skip

- 跳过指定数量的文档，并返回余下的文档
- 例2：查询从第3条开始的学生信息

```
db.stu.aggregate([{$skip:2}])
```



- 例3：统计男生、女生人数，按人数升序，取第二条数据

```
db.stu.aggregate([
    {
    	$group:{
    		_id:'$gender',
    		counter:{$sum:1}
    	}
    },
    {
    	$sort:{
    		counter:1
    	}
    },
    {
    	$skip:1
    },
    {
    	$limit:1
    }
])
```

- #### 注意顺序：先写skip，再写limit

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0911.png)







### $unwind

- 将文档中的某一个**数组类型字段拆分成多条**，每条包含数组中的一个值

**语法1**

- 对某字段数组值进行拆分

```
db.集合名称.aggregate([
	{
		$unwind:'$字段名称'
	}
])
```



- 构造数据

```
db.t2.insert({
	_id:1,
	item:'t-shirt',
	size:['S','M','L']
})
```



- 查询

```
db.t2.aggregate([
	{
		$unwind:'$size'
	}
])
```

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0912.png)

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0913.png)



**语法2**

- **对某字段值进行拆分**
- **处理空数组、非数组、无字段、null情况**

```
db.inventory.aggregate([{
    $unwind:{
        path:'$字段名称',
        preserveNullAndEmptyArrays:<boolean>#防止数据丢失
    }
}])
```

   ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/0914.png)



- 构造数据

```
db.person.insert([
{ "_id" : 1, "item" : "a", "size": [ "S", "M", "L"] },
{ "_id" : 2, "item" : "b", "size" : [ ] },
{ "_id" : 3, "item" : "c", "size": "M" },
{ "_id" : 4, "item" : "d" },
{ "_id" : 5, "item" : "e", "size" : null }
])

db.t3.aggregate([{$unwind:'$size'}])
```



**注意：**

- **查看查询结果，发现对于空数组、无字段、null的文档，都被丢弃了**
- **问：如何能不丢弃呢？**
- **答：使用语法2查询**

```
db.t3.aggregate([
	{
		$unwind:{
			path:'$sizes',
			preserveNullAndEmptyArrays:true
		}
	}
])
```

