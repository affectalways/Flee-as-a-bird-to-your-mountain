# 15.复制

### 什么是复制

- 复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性，并可以保证数据的安全性
- 复制还允许从硬件故障和服务中断中恢复数据





### 为什么要复制

- 数据备份
- 数据灾难恢复
- 读写分离
- 高（24* 7）数据可用性
- 无宕机维护
- 副本集对应用程序是透明





### 复制的工作原理

- 复制至少需要两个节点A、B...
- A是主节点，负责处理客户端请求，A宕机后，B成为主节点，A重启后，A成为从节点。
- 其余的都是从节点，负责复制主节点上的数据
- 节点常见的搭配方式为：一主一从、一主多从
- 主节点记录在其上的所有操作，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致
- 主节点与从节点进行数据交互保障数据的一致性





### 复制的特点

- N 个节点的集群
- 任何节点可作为主节点
- 所有写入操作都在主节点上
- 自动故障转移
- 自动恢复





### 设置复制节点

- 接下来的操作需要打开多个终端窗口，而且可能会连接多台ubuntu主机，会显得有些乱，建议在xshell中实现
- step1:创建数据库目录t1、t2，在Desktop目录下演示，其它目录也可以，注意权限即可

```
mkdir /home/t1 mkdir /home/t2
```

- step2:使用如下格式启动mongod，注意replSet的名称是一致的，replSet 是副本集，若想做一个副本集，名字必须一致。

```
mongod --bind_ip 192.168.31.132 --port 27018 --dbpath /home/t1 --replSet rs0
```

   ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo01.png)

```
mongod --bind_ip 192.168.31.132 --port 27019 --dbpath /home/t2 --replSet rs0
```

 ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo02.png)



- step3:新建一个终端，连接主服务器，此处设置192.168.31.132 --port 27018为主服务器

```
mongo --host 192.168.31.132 --port 27018
```

   ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo03.png)



- step4:初始化，如果想让27018做主服务器，就在27018的终端做初始化，若想在27019做主服务器，就在27019的终端做初始化

```
rs.initiate()
```

   ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo04.png)

- 初始化完成后，终端提示符如下图：

​    ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo05.png)



- step5:在终端查看当前状态

```
rs.status()
```

- 当前状态如下图：

​    ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo06.png)



- step6:在主服务器终端添加复本集27019

```
rs.add('192.168.31.132:27019')
```

​    ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo07.png)



- step7:复本集添加成功后，当前状态如下图：

​    ![0](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo08.png)

​    ![0](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo09.png)



- step8:新开一个shell窗口，连接第二个mongo服务

```
mongo --host 192.168.31.132 --port 27019
```

​    ![0](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo11.png)



- 连接成功后，提示符如下图：

​    ![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo12.png)





### 数据备份

- step9:向主服务器中插入数据

```
use test

db.createCollection("copy") 

for(i=0;i<10;i++){
	db.copy.insert({age:i})
} 
db.copy.find()
```

​    ![0](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo13.png)



- step10:在**从服务器**中查询
- 说明：如果在从服务器上进行读操作，需要设置rs.slaveOk()

**这是未设置rs.slaveOk()**

![](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo14.png)

设置rs.slaveOK()

**rs.slaveOk() db.copy.find()**

​    ![0](https://raw.githubusercontent.com/affectalways/Flee-as-a-bird-to-your-mountain/main/img/15.Mo15.png)





### 主从切换

  1.关闭主服务器27018：ctrl+c，此时从服务器27019已经变为主服务器

  2.启动源主服务器，现在他已经变为从服务器

  3.在现在的主服务器27019插入数据，从服务器27018设置rs.slaveOk(),读取数据。

  



### 其它说明

- **删除从节点**

```
rs.remove('192.168.196.128:27018')
```

- 关闭主服务器后，再重新启动，会发现原来的从服务器变为了主服务器，新启动的服务器（原来的从服务器）变为了从服务器